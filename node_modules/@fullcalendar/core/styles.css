<?php
// 引入配置文件
include ?config.php?;
// 启动会话
session_start();

// 检查用户是否已登录
if (!isset($_SESSION[?user_id?])) {
    header(?Location: login.php?);
    exit;
}

// 处理添加任务请求
if ($_SERVER[?REQUEST_METHOD?] == ?POST? ?? isset($_POST[?add_task?])) {
    $taskName = $_POST[?task_name?];
    $stmt = $conn-?prepare(?INSERT INTO daily_tasks (user_id, task_name) VALUES (?, ?)?);
    $stmt-?bind_param(?is?, $_SESSION[?user_id?], $taskName);
    if ($stmt-?execute()) {
        // 任务添加成功，重定向到当前页面以刷新任务列表
        header(?Location: daily_management.php?);
        exit;
    } else {
        // 输出错误信息
        echo ?Error adding task: ? . $stmt-?error;
    }
    $stmt-?close();
}

// 处理更新任务状态请求
if ($_SERVER[?REQUEST_METHOD?] == ?POST? ?? isset($_POST[?update_task?])) {
    $taskId = $_POST[?task_id?];
    $isCompleted = $_POST[?is_completed?];
    $stmt = $conn-?prepare(?UPDATE daily_tasks SET is_completed = ? WHERE id = ? AND user_id = ??);
    $stmt-?bind_param(?iii?, $isCompleted, $taskId, $_SESSION[?user_id?]);
    if ($stmt-?execute()) {
        // 任务状态更新成功，重定向到当前页面以刷新任务列表
        header(?Location: daily_management.php?);
        exit;
    } else {
        // 输出错误信息
        echo ?Error updating task status: ? . $stmt-?error;
    }
    $stmt-?close();
}

// 查询当前用户的所有任务
$sql = ?SELECT * FROM daily_tasks WHERE user_id = {$_SESSION[?user_id?]}?;
$result = $conn-?query($sql);

// 准备任务数据以用于日历显示
$tasks = [];
if ($result-?num_rows ? 0) {
    while ($row = $result-?fetch_assoc()) {
        $tasks[] = [
            ?title? =? $row[?task_name?],
            ?start? =? date(?Y-m-d?), // 假设所有任务都在今天，可根据实际情况修改
            ?completed? =? $row[?is_completed?]
        ];
    }
}
?>

<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>日常管理模块</title>
    <!-- 引入本地 FullCalendar 核心 CSS -->
    <link href="node_modules/@fullcalendar/core/styles.css" rel="stylesheet">
    <!-- 引入本地 FullCalendar dayGrid 插件 CSS -->
    <link href="node_modules/@fullcalendar/daygrid/styles.css" rel="stylesheet">
    <!-- 引入本地 FullCalendar 核心 JavaScript -->
    <script src="node_modules/@fullcalendar/core/index.global.js"></script>
    <!-- 引入本地 FullCalendar dayGrid 插件 JavaScript -->
    <script src="node_modules/@fullcalendar/daygrid/index.global.js"></script>
    <style>
        /* 新增导航菜单样式 */
        nav {
            background-color: #333;
            overflow: hidden;
        }

        nav a {
            float: left;
            color: white;
            text-align: center;
            padding: 14px 16px;
            text-decoration: none;
        }

        nav a:hover {
            background-color: #ddd;
            color: black;
        }

        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        ul {
            list-style-type: none;
            padding: 0;
        }

        li {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .completed {
            text-decoration: line-through;
            color: #888;
        }

        input[type="checkbox"] {
            margin-right: 10px;
        }

        #add-task-form {
            margin-top: 20px;
        }

        #calendar {
            max-width: 1100px;
            margin: 0 auto;
        }
    </style>
</head>

<body>
    <!-- 新增导航菜单 -->
    <nav>
        <a href="topics.php">选题管理</a>
        <a href="daily_management.php">日常管理</a>
    </nav>
    <h1>日常管理模块</h1>
    <div id="calendar"></div>
    <ul id="task-list">
        <!-- 
        if ($result-?num_rows ? 0) {
            while ($row = $result-?fetch_assoc()) {
                $completedClass = $row[?is_completed?] ? ?completed? : ??;
                echo ??li id=?task-{$row[?id?]}? class=?{$completedClass}???;
                echo ??input type=?checkbox? ? . ($row[?is_completed?] ? ?checked? : ??) . ? onclick=?updateTaskStatus({$row[?id?]}, this.checked)???;
                echo ??span ondblclick=?showAddTaskForm()??{$row[?task_name?]}?/span??;
                echo ??/li??;
            }
        } else {
            echo ??li?暂无任务?/li??;
        }
       -->
    </ul>
    <div id="add-task-form" style="display: none;">
        <input type="text" id="new-task-name" placeholder="输入新任务名称">
        <button onclick="addTask()">添加任务</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                // 指定使用的插件
                plugins: [FullCalendar.DayGridPlugin],
                initialView: 'dayGridMonth',
                events: x/*ph echo json_encode($tasks);\*/,
                eventContent: function (info) {
                    var completedClass = info.event.extendedProps.completed ? 'completed' : '';
                    return {
                        html: '<span class="' + completedClass + '">' + info.event.title + '</span>'
                    };
                }
            });
            calendar.render();
        });

        function showAddTaskForm() {
            document.getElementById('add-task-form').style.display = 'block';
        }

        function addTask() {
            const taskName = document.getElementById('new-task-name').value;
            if (taskName) {
                const formData = new FormData();
                formData.append('add_task', 1);
                formData.append('task_name', taskName);

                const xhr = new XMLHttpRequest();
                xhr.open('POST', 'daily_management.php', true);
                xhr.onload = function () {
                    if (xhr.status === 200) {
                        // 任务添加成功，刷新页面
                        location.reload();
                    }
                };
                xhr.send(formData);
            }
        }

        function updateTaskStatus(taskId, isCompleted) {
            const formData = new FormData();
            formData.append('update_task', 1);
            formData.append('task_id', taskId);
            formData.append('is_completed', isCompleted ? 1 : 0);

            const xhr = new XMLHttpRequest();
            xhr.open('POST', 'daily_management.php', true);
            xhr.onload = function () {
                if (xhr.status === 200) {
                    const taskItem = document.getElementById(`task-${taskId}`);
                    if (isCompleted) {
                        taskItem.classList.add('completed');
                    } else {
                        taskItem.classList.remove('completed');
                    }
                }
            };
            xhr.send(formData);
        }
    </script>
</body>

</html>
